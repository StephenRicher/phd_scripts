#!/bin/bash

capture_regions="${1}"

genome="${2}"

threads="${3}"

outdir="${4}"

shift 4

for bam in "${@}"; do

  while IFS=$'\t' read -r chr start end region; do

    dir="${outdir%/}"/diffhic/"${region}"
    mkdir -p "${dir}"

    genome_no_path="${genome##*/}"
    if [ ! -f "${dir}"/"${genome_no_path%.fa}"."${region}"-"${chr}"-$((start+1))-"${end}".fa ]; then
      samtools faidx  "${genome}" "${chr}":$((start+1))-"${end}" \
      | sed '1 s/:.*$//' \
      > "${dir}"/"${genome_no_path%.fa}"."${region}"-"${chr}"-$((start+1))-"${end}".fa
    fi

    length=$((end-start))

    samtools view -u "${bam}" "${chr}":$((start+1))-"${end}" \
     | samtools sort -n -l 0 - \
     | samtools fixmate -p - - \
     | samtools view -h -f 1 - \
     | awk -v OFS='\t' -v chr="${chr}" -v len="${length}" -v start="${start}" '/^@SQ/ {if($2!="SN:"chr) {next} else {$3="LN:"len}} !/^@/ {$4=$4-start+1; $8=$8-start+1} {print}' \
     | samtools view -F 12 -b > "${dir}"/"${bam%%.*}"."${region}".bam

  done <"${capture_regions}"

done
