#!/bin/bash

capture_regions="${1}"

genome="${2}"

threads="${3}"

outdir="${4}"

shift 4

for bam in "${@}"; do

  while IFS=$'\t' read -r chr start end region; do

    dir="${outdir%/}"/diffhic/"${region}"
    mkdir -p "${dir}"
    genome_no_path="${genome##*/}"
    if [ ! -f "${dir}"/"${genome_no_path%.fa}"."${region}".fa ]; then
      samtools faidx  "${genome}" "${chr}":$((start+1))-"${end}" \
      | sed '1 s/:.*//' \
      > "${dir}"/"${genome_no_path%.fa}"."${region}".fa
    fi

    length=$((end-start))

    #samtools view -h "${bam}" "${chr}":$((start+1))-"${end}" \
    #  | awk -v OFS='\t' -v chr="${chr}" -v len="${length}" -v start="${start}" '/^@SQ/ {if($2!="SN:"chr) {next} else {$3="LN:"len}} !/^@/ {$4=$4-start; $8=$8-start} {print}' \
    #  | samtools sort -n -l 0 -@ "${threads}" - \
    #  | samtools fixmate -p -@ "${threads}" - - \
    #  | samtools view -f 1 -F 12 -b -@ "${threads}" > "${dir}"/"${bam%%.*}"."${region}".bam

  done <"${capture_regions}"

done
