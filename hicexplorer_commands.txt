#!/usr/bin/env bash

# Activate extended globbing
shopt -s extglob

region="TET1"
location="10:66560359:70694482"

#region="DLK1_DIO3"
#location="14:99726864-102563452"
region="GNG12_AS1_DIRAS3"
location="1:67432288-68602987" # GNG12 position

#track_config="/home/stephen/x_am/RC-BB1219/stephen/projects/hic_analysis/hicexplorer_tracks/hic_track_genome_split.ini"
track_config="/home/stephen/x_am/RC-BB1219/stephen/projects/hic_analysis/hicexplorer_tracks/hic_track.ini"
#track_config_replicate="/home/stephen/x_am/RC-BB1219/stephen/projects/hic_analysis/hicexplorer_tracks/hic_track_replicate.ini"


####### BEGIN NEXT SCRIPT HERE ################## 

dir="."
samples=("HB2_CL4" "HB2_WT" "MCF7")

# Check hic interaction density for each replicate of each sample. If any are 0 then remove from sample list
delete=()
for sample in "${samples[@]}"; do
  for matrix in 1000/"${sample}"*.h5; do
    # Check if exists since empty directories will return null glob
    if [[ -f "${matrix}" ]]; then
      info=( $(hicInfo --matrices "${matrix}") )
      matrix_size=${info[13]/,/}
      matrix_sum=${info[19]/,/}
      matrix_density=$(echo "scale=3; ${matrix_sum} / (${matrix_size} * ${matrix_size})" | bc)
      if [[ "${matrix_density}" == "0" ]]; then
        >&2 echo "Removing "${sample}" from analysis due to insufficient interactions"
        delete+=("${sample}")
      fi
    fi
  done
done

for target in "${delete[@]}"; do
  for i in "${!samples[@]}"; do
    if [[ ${samples[i]} = "${target}" ]]; then
      unset 'samples[i]'
    fi
  done
done

nbin=3000

# Merge replicate samples
for sample in "${samples[@]}"; do
  hicSumMatrices --matrices "${dir}"/"${nbin}"/"${sample}"*-norm.h5 --outFileName "${dir}"/"${nbin}"/"${sample}"-"${region}"-"${nbin}"-norm_sum.h5
done

# Correct merged and unmerged matrices
for matrix in "${dir}"/"${nbin}"/*-norm*(_sum).h5; do
  hicCorrectMatrix diagnostic_plot --matrix ${matrix} -o diagnostic_plot_temp.png 2> diagnostic_temp.txt
  lower_threshold=$(grep "mad threshold" diagnostic_temp.txt | awk '{print $NF}')
  hicCorrectMatrix correct --matrix "${matrix}" --correctionMethod ICE --iterNum 1000 \
    --filterThreshold ${lower_threshold} 5 --outFileName "${matrix%.h5}"_iced.h5
  rm diagnostic_temp.txt diagnostic_plot_temp.png
done

mkdir -p "${dir}"/"${nbin}"/matrix_comparison/
for matrix1 in "${dir}"/"${nbin}"/*-norm_sum_iced.h5; do
  for matrix2 in "${dir}"/"${nbin}"/*-norm_sum_iced.h5; do
    matrix1_rmpath="${matrix1##*/}"
    matrix2_rmpath="${matrix2##*/}"
    if [ "${matrix1}" != "${matrix2}" ]; then
      # order sample names to ensure we dont duplicate checks (e.g. a vs. b and b vs. a)
      sample_ordered=$(sort <(printf "${matrix1_rmpath/-norm*}\n${matrix2_rmpath/-norm*}") | tr '\r\n' '_')
      out="${dir}"/"${nbin}"/matrix_comparison/"${sample_ordered}"log2
      if [ ! -f "${out}".h5 ]; then
        hicCompareMatrices --matrices ${matrix1} ${matrix2} \
                         --outFileName "${out}".h5 \
                         --operation log2ratio
        hicPlotMatrix --matrix "${out}".h5 \
                    --outFileName "${out}".png \
                    --clearMaskedBins --region ${location} --dpi 300 \
                    --title ${matrix1_rmpath/-norm*}_vs_${matrix2_rmpath/-norm*}_log2
      fi
    fi
  done
done

for sample in "${samples[@]}"; do
  hicCompareMatrices --matrices "${dir}"/"${nbin}"/"${sample}"*-norm_iced.h5 \
                     --outFileName "${dir}"/"${nbin}"/matrix_comparison/"${sample}"-"${region}"_replicate_log2.h5 \
                     --operation log2ratio
  hicPlotMatrix --matrix "${dir}"/"${nbin}"/matrix_comparison/"${sample}"-"${region}"_replicate_log2.h5 \
                --outFileName "${dir}"/"${nbin}"/matrix_comparison/"${sample}"-"${region}"_replicate_log2.png \
                --clearMaskedBins --region ${location} --dpi 300 \
                --title "${sample}"-"${region}"_replicate_log2
done

# Perform loop detection on unmerged and summed HiC matrices and plot. If no loops detected then run without the loops
mkdir "${dir}"/"${nbin}"/hic_plots

# Define vMax for standardised colour scales in hicPlots - different vMax for summed and not summed matrices
vMax_sum=$(hicInfo --matrices "${dir}"/"${nbin}"/*-norm_sum_iced.h5 | grep Maximum | cut -d ':' -f 2 | sort -r | head -n 1)
vMax_not_sum=$(hicInfo --matrices "${dir}"/"${nbin}"/*-norm_iced.h5 | grep Maximum | cut -d ':' -f 2 | sort -r | head -n 1)


for matrix in "${dir}"/"${nbin}"/*-norm_?(sum_)iced.h5; do
  matrix_rmpath="${matrix##*/}"
  loops_file="${dir}"/"${nbin}"/hic_plots/${matrix_rmpath/.h5}_loops.bedgraph
  hicDetectLoops --matrix ${matrix} -o "${loops_file}" \
                 --maxLoopDistance 2000000 --windowSize 10 --peakWidth 6 \
                 --pValuePreselection 0.05 --pValue 0.5 --peakInteractionsThreshold 20

  if [[ "${matrix}" == *"_sum_"* ]]; then
    vMax=${vMax_sum}
  else
    vMax=${vMax_not_sum}
  fi

  if [ -f "${loops_file}" ]; then
    hicPlotMatrix --matrix ${matrix} --outFileName "${dir}"/"${nbin}"/hic_plots/${matrix_rmpath/.h5}.png \
                --log1p --region ${location} --loops "${loops_file}" \
                --title ${matrix/.h5} --dpi 300 --vMin 1 --vMax ${vMax}
  else
     hicPlotMatrix --matrix ${matrix} --outFileName "${dir}"/"${nbin}"/hic_plots/${matrix_rmpath/.h5}.png \
                --log1p --region ${location} \
                --title ${matrix/.h5} --dpi 300 --vMin 1 --vMax ${vMax}
  fi
done

montage "${dir}"/"${nbin}"/hic_plots/*-norm_iced.png -geometry 1200x1200+1+1 -tile 2x "${dir}"/"${nbin}"/hic_plots/${region}_${nbin}_hic_plots.png
montage "${dir}"/"${nbin}"/hic_plots/*-norm_sum_iced.png -geometry 1200x1200+1+1 -tile x1 "${dir}"/"${nbin}"/hic_plots/${region}-${nbin}-sum_hic_plots.png

mkdir "${dir}"/"${nbin}"/tads
mkdir "${dir}"/"${nbin}"/tad_plots
for delta in 0.001 0.005 0.01 0.05; do
  for threshold in 0.001 0.005 0.01 0.05; do

    # Detect TADS from both summed and unsummed restriction fragment resolution and merged resolution HiC matrices
    for matrix in "${dir}"/"${nbin}"/*-norm_?(sum_)iced.h5; do
      matrix_rmpath="${matrix##*/}"
      hicFindTADs --matrix "${matrix}" --outPrefix "${dir}"/"${nbin}"/tads/${matrix_rmpath/-norm_*iced.h5}-TADS_d_${delta}_t_${threshold} \
                  --correctForMultipleTesting fdr --thresholdComparisons ${threshold} --delta ${delta}
    done

    #for track in "${track_config}" "${track_config_replicate}"; do
    for track in "${track_config}"; do
      
      temp_track="${dir}"/"${nbin}"/tad_plots/"${track##*/}"_temp.ini

      sed "s/-region-/-${region}-/g" ${track} > "${temp_track}"
      sed -i "s/-binsize-/-${nbin}-/g" "${temp_track}"
      sed -i "s/d_delta_t_threshold/d_${delta}_t_${threshold}/g" "${temp_track}"
      sed -i "s/-binsize-/-${nbin}-/g" "${temp_track}"
      sed -i "s/directory/"${dir}"\/"${nbin}"/g" "${temp_track}"

      for target in "${delete[@]}"; do
        sed -i "/Start "${target}"/,/End "${target}"/d" "${temp_track}"
      done

      if [ "${track}" == "${track_config_replicate}" ]; then
        plotname="${dir}"/"${nbin}"/tad_plots/${region}_replicate_${nbin}_d_${delta}_t_${threshold}.png
      else
        plotname="${dir}"/"${nbin}"/tad_plots/${region}_${nbin}_d_${delta}_t_${threshold}.png
      fi

      # Plot track first to identifiy max HiC value across all HiC matrices.
      hicPlotTADs --tracks "${temp_track}" --region ${location} --outFileName "${plotname}" --dpi 300 2> "${dir}"/"${nbin}"/tad_plots/${track##*/}_plot_log_temp.txt

      # Extract max value from hicPlotTADs outut and insert to new temp track.ini file.
      max_hic_value=$(grep "max values for track" "${dir}"/"${nbin}"/tad_plots/${track##*/}_plot_log_temp.txt | awk '{print $NF}' | sort -nr | head -n 1)
      sed -i "s/#max_value = none/max_value = ${max_hic_value}/g" "${temp_track}"
        
      # Replot the graph.
      hicPlotTADs --tracks "${temp_track}" --region ${location} --outFileName "${plotname}" --title ${region}_delta_${delta}_threshold_${threshold} --dpi 300 
    done
  done
done
# Remove temporary files
rm "${temp_track}" "${dir}"/"${nbin}"/tad_plots/${track%.*}_plot_log_temp.txt

















































mkdir tads
mkdir tad_plots
for res in ${nbin}000 rf ; do
   {
   for delta in 0.001 0.005 0.01 0.05; do
      for threshold in 0.001 0.005 0.01 0.05; do

         # Detect TADS from both summed and unsummed restriction fragment resolution and merged resolution HiC matrices
         for matrix in *${region}*${res}-norm_*correct.h5; do
            hicFindTADs --matrix ${matrix} --outPrefix tads/${matrix/-norm_*correct.h5}-TADS_d_${delta}_t_${threshold} \
                         --correctForMultipleTesting fdr --thresholdComparisons ${threshold} --delta ${delta}
         done

         #for track in "${track_config}" "${track_config_replicate}"; do
         for track in "${track_config}"; do

            sed "s/-region-/-${region}-/g" ${track} > ${track%.*}_${res}_temp.ini
            sed -i "s/-binsize-/-${nbin}000-/g" ${track%.*}_${res}_temp.ini
            sed -i "s/d_delta_t_threshold/d_${delta}_t_${threshold}/g" ${track%.*}_${res}_temp.ini
            sed -i "s/-resolution-/-${res}-/g" ${track%.*}_${res}_temp.ini

            for target in "${delete[@]}"; do
              sed -i "/Start "${target}"/,/End "${target}"/d" ${track%.*}_${res}_temp.ini
            done

            if [ "${track}" == "${track_config_replicate}" ]; then
               plotname="tad_plots/${region}_replicate_${res}_d_${delta}_t_${threshold}.png"
            else
               plotname="tad_plots/${region}_${res}_d_${delta}_t_${threshold}.png"
            fi

            # Plot track first to identifiy max HiC value across all HiC matrices.
            hicPlotTADs --tracks ${track%.*}_${res}_temp.ini --region ${location} --outFileName "${plotname}" --dpi 300 2> ${track%.*}_${res}_plot_log_temp.txt

            # Extract max value from hicPlotTADs outut and insert to new temp track.ini file.
            max_hic_value=$(grep "max values for track" ${track%.*}_${res}_plot_log_temp.txt | awk '{print $NF}' | sort -nr | head -n 1)
            sed -i "s/#max_value = none/max_value = ${max_hic_value}/g" ${track%.*}_${res}_temp.ini
        
            # Replot the graph.
            hicPlotTADs --tracks ${track%.*}_${res}_temp.ini --region ${location} --outFileName "${plotname}" --title ${region}_delta_${delta}_threshold_${threshold} --dpi 300 

         done
      done
   done
   }
done; wait
# Remove temporary files
rm ${track%.*}_temp.ini ${track%.*}_plot_log_temp.txt



mkdir viewpoint
ref="1:67831302-67832302"
start_end=${ref/*:/}
length=200000
view_region=${ref/:*/}:$((${start_end/-*/}-${length}))-$((${start_end/*-/}+${length}))

hicPlotViewpoint --matrix *${region}*${nbin}000-norm_sum_correct.h5 --region ${view_region} --referencePoint ${ref} --interactionOutFileName viewpoint/${region}-${nbin}000.bed --outFileName viewpoint/${region}-${nbin}000.png --dpi 300
hicPlotViewpoint --matrix *${region}*10000-norm_sum_correct.h5 --region ${view_region} --referencePoint ${ref} --interactionOutFileName viewpoint/${region}-10000.bed --outFileName viewpoint/${region}-10000.png --dpi 300
hicPlotViewpoint --matrix *${region}*rf-norm_sum_correct.h5 --region ${view_region} --referencePoint ${ref} --interactionOutFileName viewpoint/${region}-rf.bed --outFileName viewpoint/${region}-rf.png --dpi 300

