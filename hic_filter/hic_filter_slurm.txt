#!/bin/bash

#SBATCH --account=ba-fs6sdb
#SBATCH --job-name=hic_filter_%j
#SBATCH --output=/home/u/sr467/scratch/projects/HiC/job_logs/hic_filter_%j.out
#SBATCH --error=/home/u/sr467/scratch/projects/HiC/job_logs/hic_filter_%j.err
#SBATCH --workdir=/home/u/sr467/scratch/projects/HiC/all_samples/
#SBATCH --partition=batch
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=16
#SBATCH --time=06:00:00
#SBATCH --mail-type=ALL
#SBATCH --mail-user=sr467@bath.ac.uk

module purge
module load slurm
module load openmpi/intel
module load python3
module load samtools/1.9

digest_file="/home/u/sr467/scratch/projects/genomes/GRCh38/wgs/GRCh38_primary_assembly_Mbo1_digest.txt"
hic_filter="/u/u/sr467/phd/scripts2/hic_scripts/hic_filter/hic_filter.py"

bams=( $(ls *name_sorted.bam) )

for bam in "${bams[@]}"; do
  mpirun samtools view "${bam}" | "${hic_filter}" -d "${digest_file}" > "${bam/name_sorted.bam/}".filter_stats.txt &
done; wait
